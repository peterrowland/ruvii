<!DOCTYPE html><html lang="en"><head><title>features/wtf</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="features/wtf"><meta name="groc-project-path" content="lib/ruvii/features/wtf.rb"><meta name="groc-github-url" content="https://github.com/wavii/ruvii"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/wavii/ruvii/blob/master/lib/ruvii/features/wtf.rb">lib/ruvii/features/wtf.rb</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="wtf">wtf?</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nb">require</span> <span class="s2">&quot;ruvii/dependencies&quot;</span>

<span class="k">module</span> <span class="nn">Ruvii::WTF</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It'd be nice to know just where the fuck that method is defined, wouldn't it?</p>

<p>When you're lost, don't forget that you can ask WTF:</p>

<p>some<em>obj.wtf? :method</em>name</p></div></div><div class="code"><div class="wrapper">  <span class="k">def</span> <span class="nf">wtf?</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="nb">print</span><span class="o">=</span><span class="kp">true</span><span class="p">)</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="o">::</span><span class="no">Ruvii</span><span class="o">::</span><span class="no">WTF</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Raises on missing method</p></div></div><div class="code"><div class="wrapper">    <span class="nb">method</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">instance_method</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">method</span><span class="o">.</span><span class="n">source_location</span>
      <span class="n">file</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="nb">method</span><span class="o">.</span><span class="n">source_location</span>
      <span class="n">location</span>   <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">scope</span><span class="o">.</span><span class="n">green</span> <span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">scope</span><span class="o">.</span><span class="n">yellow</span> <span class="n">line</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Nicely highlighted source.  We want to give a bit of context around the definition.</p></div></div><div class="code"><div class="wrapper">      <span class="n">source</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">method_source_lines</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line_num</span><span class="p">,</span> <span class="n">line_text</span><span class="p">,</span> <span class="n">is_target</span><span class="o">|</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The specific def line is also called out</p></div></div><div class="code"><div class="wrapper">        <span class="n">line_text</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">green</span><span class="p">(</span><span class="n">line_text</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_target</span>
        <span class="s2">&quot;  </span><span class="si">#{</span><span class="n">scope</span><span class="o">.</span><span class="n">white</span> <span class="n">line_num</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">#{</span><span class="n">line_text</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">location</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">red</span> <span class="s2">&quot;Unknown Location&quot;</span>
    <span class="k">end</span>

    <span class="n">method_desc</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">method_desc</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="nb">self</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span>

    <span class="n">message</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">scope</span><span class="o">.</span><span class="n">yellow</span> <span class="n">method_desc</span><span class="si">}</span><span class="s2"> defined at </span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">source</span>

    <span class="n">scope</span><span class="o">.</span><span class="n">emit</span> <span class="n">message</span><span class="p">,</span> <span class="nb">print</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">include</span> <span class="no">Term</span><span class="o">::</span><span class="no">ANSIColor</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Our default mode is to just print out the message; we assume that you're running this from
a terminal (either in IRB, or via a script)</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">print</span><span class="p">)</span>
      <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip_heredoc</span><span class="o">.</span><span class="n">strip</span>

      <span class="k">if</span> <span class="nb">print</span>
        <span class="nb">puts</span>
        <span class="nb">puts</span> <span class="n">message</span>
        <span class="nb">puts</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>getting a huge string back in IRB is annoying as fawk.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="kp">nil</span>
      <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alternatively, if you turn of printing you <em>can</em> get the string back.  Helpful for scripting
or testing.</p></div></div><div class="code"><div class="wrapper">      <span class="nb">self</span><span class="o">.</span><span class="n">uncolored</span> <span class="n">message</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates the pretty form of a method.</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">method_desc</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Method#inspect does a pretty good job of this.  Class(Module)#method or Class#method</p></div></div><div class="code"><div class="wrapper">      <span class="n">base</span> <span class="o">=</span> <span class="nb">method</span><span class="o">.</span><span class="n">inspect</span><span class="o">[/^</span><span class="p">\</span><span class="c1">#&lt;\S+ (.+)\#.+&gt;$/, 1]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>However, singletons are a bit goofy and look like #<Class:Class></p></div></div><div class="code"><div class="wrapper">      <span class="n">base</span> <span class="o">=</span> <span class="vg">$1</span> <span class="k">if</span> <span class="n">base</span> <span class="o">=~</span> <span class="sr">/^\#&lt;Class:(.+)&gt;$/</span>

      <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Module</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Rewrite singleton calls so that we have . instead of #</p></div></div><div class="code"><div class="wrapper">        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;Class(&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>

        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="n">sym</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attempts to extract useful context around a method definition</p>

<p>Returns an array of tuples: <code>[line_num, line_text, is_target]</code></p>

<p>Line num is a string, and padded</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="nf">method_source_lines</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Yeah, we're not memory efficient here.</p></div></div><div class="code"><div class="wrapper">      <span class="n">lines</span>  <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
      <span class="n">result</span> <span class="o">=</span> <span class="o">[]</span>

      <span class="n">min_index</span> <span class="o">=</span> <span class="n">line_num</span> <span class="o">-</span> <span class="n">context</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="n">max_index</span> <span class="o">=</span> <span class="n">line_num</span> <span class="o">+</span> <span class="n">context</span>

      <span class="n">max_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">length</span>

      <span class="p">(</span><span class="n">min_index</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">max_index</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">index</span><span class="o">|</span>
        <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">max_width</span><span class="p">),</span> <span class="n">lines</span><span class="o">[</span><span class="n">index</span><span class="o">].</span><span class="n">rstrip</span><span class="p">,</span> <span class="n">index</span> <span class="o">==</span> <span class="n">line_num</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">result</span>
    <span class="k">end</span>

  <span class="k">end</span>

<span class="k">end</span>

<span class="no">Object</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span> <span class="no">Ruvii</span><span class="o">::</span><span class="no">WTF</span></div></div></div></div></body></html>